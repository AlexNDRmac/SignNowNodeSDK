<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">lib/document.js | SignNow API client</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<link rel="stylesheet" href="./inject/css/0-logo.css"><meta name="description" content="SignNow REST Service Wrapper"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="SignNow API client"><meta property="twitter:description" content="SignNow REST Service Wrapper"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./" style="display: flex; align-items: center;"><img src="./image/brand_logo.svg" style="width:34px;"></a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/signnow/SignNowNodeSDK"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-cancelInvite">cancelInvite</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-create">create</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-download">download</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-fieldextract">fieldextract</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-history">history</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-invite">invite</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-list">list</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-merge">merge</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-share">share</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-update">update</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-view">view</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-addField">addField</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-addOptions">addOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-documents">documents</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-list">list</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-signnow">signnow</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-create">create</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-requestToken">requestToken</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-verify">verify</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-create">create</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-duplicate">duplicate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-create">create</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-retrieve">retrieve</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-create">create</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-list">list</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lib/document.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;;
const https = require(&apos;https&apos;);
const fs = require(&apos;fs&apos;);
const {
  responseHandler, errorHandler, buildRequestOptions,
} = require(&apos;./common&apos;);


/**
 * Document Methods
 */

// build file multipart/form-data request
function buildFileRequest (boundaryKey, mimeType, filename) {
  let req = `------FormBoundary${boundaryKey}\r\n`;
  req += `Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;${filename}&quot;\r\n`;
  req += `Content-Type: ${mimeType}\r\n\r\n`;

  // req += &apos;Content-Transfer-Encoding: binary\r\n\r\n&apos;;
  return req;
}

// get file mime type
function getMimeType (path) {
  const extTypes = {
    doc: &apos;application/msword&apos;,
    docx: &apos;application/vnd.openxmlformats-officedocument.wordprocessingml.document&apos;,
    pdf: &apos;application/pdf&apos;,
    png: &apos;image/png&apos;,
  };
  const pathExtension = path.substr(path.lastIndexOf(&apos;.&apos;)).replace(&apos;.&apos;, &apos;&apos;);
  return extTypes[pathExtension.toLowerCase()] || null;
}

// get filename from path
function getFileName (path) {
  if (path.lastIndexOf(&apos;/&apos;) !== -1) {
    return path.substr(path.lastIndexOf(&apos;/&apos;)).replace(&apos;/&apos;, &apos;&apos;);
  } else {
    return path;
  }
}

// generate randon string
function randString (x) {
  let s = &apos;&apos;;
  while (s.length &lt; x &amp;&amp; x &gt; 0) {
    const r = Math.random();
    s += (r &lt; 0.1 ? Math.floor(r * 100) : String.fromCharCode(Math.floor(r * 26) + (r &gt; 0.5 ? 97 : 65)));
  }
  return s;
}

// uploads a file and creates a document. This endpoint accepts .doc, .docx, .pdf, and .png file types
exports.create = function(obj, callback) {
  const boundaryKey = randString(30);
  const filename = getFileName(obj.filepath);

  // check mimetype
  let mimeType = &apos;&apos;;
  if (getMimeType(obj.filepath)) {
    mimeType = getMimeType(obj.filepath);
  } else {
    return callback(&apos;File type isn\&apos;t supported.&apos;);
  }

  const file = buildFileRequest(boundaryKey, mimeType, filename);
  const stat = fs.statSync(obj.filepath);
  const reader = fs.createReadStream(obj.filepath, { bufferSize: 64 * 1024 });
  const closingLine = `\r\n------FormBoundary${boundaryKey}--`;

  const req = https.request(buildRequestOptions({
    method: &apos;POST&apos;,
    path: &apos;/document&apos;,
    authorization: {
      type: &apos;Bearer&apos;,
      token: obj.token,
    },
    headers: {
      &apos;Content-Type&apos;: `multipart/form-data; boundary=----FormBoundary${boundaryKey}`,
      &apos;Content-Length&apos;: stat.size + file.toString().length + closingLine.length,
    },
  }), responseHandler(callback));

  req.on(&apos;error&apos;, errorHandler(callback));
  req.write(file);

  reader.on(&apos;end&apos;, () =&gt; {
    reader.unpipe(req);
    req.end(closingLine);
  });

  // pipe the file and append a closing line
  reader.pipe(req, { end: false });

};

/*
 * uploads a file that contains signnow Document Field Tags. This endpoint
 * only accepts .pdf (You may convert the document from .doc or .docx to .pdf)
 */

exports.fieldextract = function(obj, callback) {
  const boundaryKey = randString(30);
  const filename = getFileName(obj.filepath);

  // check mimetype
  let mimeType = &apos;&apos;;
  if (getMimeType(obj.filepath)) {
    mimeType = getMimeType(obj.filepath);
  } else {
    return callback(&apos;File type isn\&apos;t supported.&apos;);
  }

  const file = buildFileRequest(boundaryKey, mimeType, filename);
  const stat = fs.statSync(obj.filepath);
  const reader = fs.createReadStream(obj.filepath, { bufferSize: 64 * 1024 });
  const closingLine = `\r\n------FormBoundary${boundaryKey}--`;

  const req = https.request(buildRequestOptions({
    method: &apos;POST&apos;,
    path: &apos;/document/fieldextract&apos;,
    authorization: {
      type: &apos;Bearer&apos;,
      token: obj.token,
    },
    headers: {
      &apos;Content-Type&apos;: `multipart/form-data; boundary=----FormBoundary${boundaryKey}`,
      &apos;Content-Length&apos;: stat.size + file.toString().length + closingLine.length,
    },
  }), responseHandler(callback));

  req.on(&apos;error&apos;, errorHandler(callback));
  req.write(file);

  // pipe the file and append a closing line
  reader.pipe(req, { end: false });

  reader.on(&apos;end&apos;, () =&gt; {
    reader.unpipe(req);
    req.end(closingLine);
  });
};

// list all documents for user
exports.list = function(obj, callback) {
  const req = https.request(buildRequestOptions({
    method: &apos;GET&apos;,
    path: &apos;/user/documentsv2&apos;,
    authorization: {
      type: &apos;Bearer&apos;,
      token: obj.token,
    },
  }), responseHandler(callback));

  req.on(&apos;error&apos;, errorHandler(callback));
  req.end();
};

// retrieve a document resource
exports.view = function(obj, callback) {
  const req = https.request(buildRequestOptions({
    method: &apos;GET&apos;,
    path: `/document/${obj.id}`,
    authorization: {
      type: &apos;Bearer&apos;,
      token: obj.token,
    },
  }), responseHandler(callback));

  req.on(&apos;error&apos;, errorHandler(callback));
  req.end();
};

// update an existing document. Add fields [signature | text | initials | checkbox ], elements [signature | text | check]
exports.update = function(obj, callback) {
  const JSONData = JSON.stringify(obj.fields);

  const req = https.request(buildRequestOptions({
    method: &apos;PUT&apos;,
    path: `/document/${obj.id}`,
    authorization: {
      type: &apos;Bearer&apos;,
      token: obj.token,
    },
    headers: {
      &apos;Content-Type&apos;: &apos;application/json&apos;,
      &apos;Content-Length&apos;: Buffer.byteLength(JSONData),
    },
  }), responseHandler(callback));

  req.on(&apos;error&apos;, errorHandler(callback));
  req.write(JSONData);
  req.end();
};

// download a collapsed document
exports.download = function(obj, callback) {
  const req = https.request(buildRequestOptions({
    method: &apos;GET&apos;,
    path: `/document/${obj.id}/download?type=collapsed`,
    authorization: {
      type: &apos;Bearer&apos;,
      token: obj.token,
    },
  }), responseHandler(callback, { parse: false }));

  req.on(&apos;error&apos;, errorHandler(callback));
  req.end();
};

// creates a one-time use URL for anyone to download the document as a PDF.
exports.share = function(obj, callback) {
  const req = https.request(buildRequestOptions({
    method: &apos;POST&apos;,
    path: `/document/${obj.id}/download/link`,
    authorization: {
      type: &apos;Bearer&apos;,
      token: obj.token,
    },
  }), responseHandler(callback));

  req.on(&apos;error&apos;, errorHandler(callback));
  req.end();
};

/*
 * TODO: Invite stuck open breaking other request
 * create an invite to sign a document. You can create a simple free form invite or a role-based invite.
 */

exports.invite = function(obj, callback) {
  const JSONData = JSON.stringify(obj.data);
  let path = &apos;&apos;;

  if (obj &amp;&amp; obj.options !== undefined &amp;&amp; (obj.options.email !== undefined &amp;&amp; obj.options.email === &apos;disable&apos;)) {
    path = `/document/${obj.id}/invite?email=disable`;
  } else {
    path = `/document/${obj.id}/invite`;
  }

  const req = https.request(buildRequestOptions({
    method: &apos;POST&apos;,
    authorization: {
      type: &apos;Bearer&apos;,
      token: obj.token,
    },
    headers: {
      &apos;Content-Type&apos;: &apos;application/json&apos;,
      &apos;Content-Length&apos;: Buffer.byteLength(JSONData),
    },
    path,
  }), responseHandler(callback));

  req.on(&apos;error&apos;, errorHandler(callback));
  req.write(JSONData);
  req.end();
};

// cancel an invite to a document.
exports.cancelInvite = function(obj, callback) {
  const req = https.request(buildRequestOptions({
    method: &apos;PUT&apos;,
    path: `/document/${obj.id}/fieldinvitecancel`,
    authorization: {
      type: &apos;Bearer&apos;,
      token: obj.token,
    },
  }), responseHandler(callback));

  req.on(&apos;error&apos;, errorHandler(callback));
  req.end();
};

// merges existing documents into one.
exports.merge = function(obj, callback) {
  const JSONData = JSON.stringify({
    name: obj.name,
    document_ids: obj.document_ids,
    upload_document: true,
  });

  const req = https.request(buildRequestOptions({
    method: &apos;POST&apos;,
    path: &apos;/document/merge&apos;,
    authorization: {
      type: &apos;Bearer&apos;,
      token: obj.token,
    },
    headers: {
      &apos;Content-Type&apos;: &apos;application/json&apos;,
      &apos;Content-Length&apos;: Buffer.byteLength(JSONData),
    },
  }), responseHandler(callback));

  req.on(&apos;error&apos;, errorHandler(callback));
  req.write(JSONData);
  req.end();
};

// get the history of a document
exports.history = function(obj, callback) {
  const req = https.request(buildRequestOptions({
    method: &apos;GET&apos;,
    path: `/document/${obj.id}/history`,
    authorization: {
      type: &apos;Bearer&apos;,
      token: obj.token,
    },
  }), responseHandler(callback));

  req.on(&apos;error&apos;, errorHandler(callback));
  req.end();
};
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
